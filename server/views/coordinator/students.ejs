<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= typeof title !== 'undefined' ? title : 'Students Management' %></title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Custom Styles -->
    <style>
        :root {
            --buk-blue: #0d6efd;
            --buk-dark: #212529;
        }
        
        .table th {
            font-weight: 600;
            color: var(--buk-dark);
        }

        .badge {
            font-weight: 500;
        }

        .card {
            transition: all 0.3s ease;
        }

        .page-title {
            color: var(--buk-dark);
            font-weight: 700;
        }
        
        .page-subtitle {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .student-avatar {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .stats-card {
            border-left: 4px solid;
            transition: transform 0.2s ease;
        }

        .stats-card:hover {
            transform: translateY(-2px);
        }

        .student-card {
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
        }

        .student-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .assigned-badge { background-color: #28a745; }
        .unassigned-badge { background-color: #ffc107; color: #000; }
        .inactive-badge { background-color: #6c757d; }

        .filter-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
        }

        /* Fix for modal scroll and stacking */
        .modal {
            --bs-modal-margin: 1.75rem;
        }

        body.modal-open {
            overflow: hidden !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="page-title mb-1">
                            <i class="bi bi-people-fill me-2"></i>Students Management
                        </h1>
                        <p class="page-subtitle mb-0">
                            Manage <%= typeof level !== 'undefined' ? level : '' %> Level students
                        </p>
                    </div>
                    <div class="text-end">
                        <div class="btn-group">
                            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                                <i class="bi bi-person-plus me-1"></i>Add Student
                            </button>
                            <button class="btn btn-outline-secondary" id="refreshBtn">
                                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert Messages -->
        <% if (typeof success !== 'undefined' && success) { %>
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle-fill me-2"></i><%= success %>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        <% } %>
        
        <% if (typeof error !== 'undefined' && error) { %>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i><%= error %>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        <% } %>

        <!-- Quick Statistics -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stats-card border-left-primary border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title text-muted mb-2">Total Students</h6>
                                <h3 class="fw-bold text-primary mb-0"><%= totalStudents || 0 %></h3>
                            </div>
                            <div class="bg-primary bg-opacity-10 p-3 rounded">
                                <i class="bi bi-people-fill text-primary fs-4"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stats-card border-left-success border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title text-muted mb-2">Assigned</h6>
                                <h3 class="fw-bold text-success mb-0"><%= assignedStudents || 0 %></h3>
                                <small class="text-muted">
                                    <%= totalStudents > 0 ? ((assignedStudents / totalStudents) * 100).toFixed(1) : 0 %>% assigned
                                </small>
                            </div>
                            <div class="bg-success bg-opacity-10 p-3 rounded">
                                <i class="bi bi-person-check text-success fs-4"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stats-card border-left-warning border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title text-muted mb-2">Unassigned</h6>
                                <h3 class="fw-bold text-warning mb-0"><%= unassignedStudents || 0 %></h3>
                                <small class="text-muted">
                                    <%= totalStudents > 0 ? ((unassignedStudents / totalStudents) * 100).toFixed(1) : 0 %>% unassigned
                                </small>
                            </div>
                            <div class="bg-warning bg-opacity-10 p-3 rounded">
                                <i class="bi bi-person-x text-warning fs-4"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stats-card border-left-info border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title text-muted mb-2">Active This Month</h6>
                                <h3 class="fw-bold text-info mb-0"><%= activeStudents || 0 %></h3>
                                <small class="text-muted">Submitted reports</small>
                            </div>
                            <div class="bg-info bg-opacity-10 p-3 rounded">
                                <i class="bi bi-activity text-info fs-4"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body filter-section">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Search Students</label>
                        <div class="input-group">
                            <span class="input-group-text bg-white">
                                <i class="bi bi-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search by name, email, or ID...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Assignment Status</label>
                        <select class="form-select" id="statusFilter">
                            <option value="all">All Students</option>
                            <option value="assigned">Assigned Only</option>
                            <option value="unassigned">Unassigned Only</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Department</label>
                        <select class="form-select" id="departmentFilter">
                            <option value="all">All Departments</option>
                            <% if (typeof departments !== 'undefined' && departments.length > 0) { 
                                departments.forEach(dept => { %>
                                <option value="<%= dept %>"><%= dept %></option>
                            <% }); } %>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-outline-secondary w-100" id="resetFilters">
                            <i class="bi bi-arrow-counterclockwise me-1"></i>Reset
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Students Grid View -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-semibold">
                        <i class="bi bi-grid-3x3-gap me-2"></i>Students Overview
                    </h5>
                    <div class="d-flex gap-2">
                        <div class="input-group input-group-sm" style="width: 250px;">
                            <span class="input-group-text bg-white">
                                <i class="bi bi-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control" id="searchStudents" placeholder="Search students...">
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <% if (students && students.length > 0) { %>
                    <div class="row" id="studentsGrid">
                        <% students.forEach((student, index) => { 
                            const isAssigned = student.supervisor && student.supervisor.id;
                            const statusClass = isAssigned ? 'assigned-badge' : 'unassigned-badge';
                            const statusText = isAssigned ? 'Assigned' : 'Unassigned';
                            
                            const initials = student.full_name.split(' ').map(n => n[0]).join('').toUpperCase();
                        %>
                            <div class="col-xl-4 col-lg-6 mb-4 student-item" 
                                 data-name="<%= student.full_name.toLowerCase() %>"
                                 data-email="<%= student.email.toLowerCase() %>"
                                 data-status="<%= isAssigned ? 'assigned' : 'unassigned' %>"
                                 data-department="<%= (student.department || '').toLowerCase() %>">
                                <div class="card student-card h-100 border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex align-items-start mb-3">
                                            <div class="student-avatar me-3">
                                                <%= initials.substring(0, 2) %>
                                            </div>
                                            <div class="flex-grow-1">
                                                <h5 class="card-title mb-1 fw-semibold"><%= student.full_name %></h5>
                                                <p class="text-muted mb-2 small">
                                                    <i class="bi bi-envelope me-1"></i><%= student.email %>
                                                </p>
                                                <% if (student.student_id) { %>
                                                    <small class="text-muted">
                                                        <i class="bi bi-person-badge me-1"></i>ID: <%= student.student_id %>
                                                    </small>
                                                <% } %>
                                            </div>
                                            <span class="badge <%= statusClass %>">
                                                <%= statusText %>
                                            </span>
                                        </div>

                                        <!-- Student Details -->
                                        <div class="mb-3">
                                            <div class="row small text-muted">
                                                <% if (student.department) { %>
                                                    <div class="col-12 mb-1">
                                                        <i class="bi bi-building me-1"></i>
                                                        <%= student.department %>
                                                    </div>
                                                <% } %>
                                                <% if (student.phone) { %>
                                                    <div class="col-12 mb-1">
                                                        <i class="bi bi-telephone me-1"></i>
                                                        <%= student.phone %>
                                                    </div>
                                                <% } %>
                                                <div class="col-12">
                                                    <i class="bi bi-calendar me-1"></i>
                                                    Level: <%= student.level || 'Not specified' %>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Supervisor Assignment -->
                                        <div class="mb-3">
                                            <h6 class="fw-semibold mb-2">Supervisor</h6>
                                            <% if (isAssigned) { %>
                                                <div class="d-flex align-items-center justify-content-between p-2 bg-light rounded">
                                                    <div>
                                                        <div class="fw-medium"><%= student.supervisor.full_name %></div>
                                                        <small class="text-muted"><%= student.supervisor.email %></small>
                                                    </div>
                                                    <form action="/coordinator/unassign-student/<%= student.assignmentId || student.id %>" 
                                                          method="POST" 
                                                          class="d-inline">
                                                        <button type="submit" 
                                                                class="btn btn-sm btn-outline-danger"
                                                                onclick="return confirm('Unassign <%= student.full_name %> from <%= student.supervisor.full_name %>?')">
                                                            <i class="bi bi-x"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            <% } else { %>
                                                <p class="text-muted small mb-2">No supervisor assigned</p>
                                            <% } %>
                                        </div>

                                        <!-- Recent Activity -->
                                        <div class="mb-3">
                                            <h6 class="fw-semibold mb-2">Recent Activity</h6>
                                            <% if (student.last_report_date) { %>
                                                <small class="text-success">
                                                    <i class="bi bi-check-circle me-1"></i>
                                                    Last report: <%= new Date(student.last_report_date).toLocaleDateString() %>
                                                </small>
                                            <% } else { %>
                                                <small class="text-muted">
                                                    <i class="bi bi-clock me-1"></i>
                                                    No reports submitted
                                                </small>
                                            <% } %>
                                        </div>

                                        <!-- Actions -->
                                        <div class="d-grid gap-2">
                                            <% if (!isAssigned) { %>
                                                <button class="btn btn-primary btn-sm assign-btn"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#assignModal"
                                                        data-student-id="<%= student.id %>"
                                                        data-student-name="<%= student.full_name %>">
                                                    <i class="bi bi-person-plus me-1"></i>
                                                    Assign Supervisor
                                                </button>
                                            <% } else { %>
                                                <button class="btn btn-outline-primary btn-sm assign-btn"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#assignModal"
                                                        data-student-id="<%= student.id %>"
                                                        data-student-name="<%= student.full_name %>"
                                                        data-current-supervisor="<%= student.supervisor.id %>">
                                                    <i class="bi bi-arrow-repeat me-1"></i>
                                                    Reassign Supervisor
                                                </button>
                                            <% } %>
                                            
                                            <div class="btn-group w-100">
                                
                                                <button class="btn btn-outline-warning btn-sm"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#editStudentModal"
                                                        data-student-id="<%= student.id %>"
                                                        data-student-name="<%= student.full_name %>"
                                                        data-student-email="<%= student.email %>"
                                                        data-student-department="<%= student.department || '' %>"
                                                        data-student-phone="<%= student.phone || '' %>"
                                                        data-student-id-number="<%= student.student_id || '' %>">
                                                    <i class="bi bi-pencil me-1"></i>Edit
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    </div>
                <% } else { %>
                    <div class="text-center py-5">
                        <i class="bi bi-people display-1 text-muted opacity-25 mb-3"></i>
                        <h4 class="text-muted">No Students Found</h4>
                        <p class="text-muted">There are no students in <%= level %> Level.</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                            <i class="bi bi-person-plus me-1"></i>Add First Student
                        </button>
                    </div>
                <% } %>
            </div>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div class="modal fade" id="addStudentModal" tabindex="-1" aria-modal="true" data-bs-backdrop="static" data-bs-keyboard="false" style="overflow-y:auto;">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <form action="/coordinator/add-student" method="POST">
                    <div class="modal-header">
                        <h5 class="modal-title">Add New Student</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Full Name</label>
                                    <input type="text" class="form-control" name="full_name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Student ID</label>
                                    <input type="text" class="form-control" name="student_id" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Email</label>
                                    <input type="email" class="form-control" name="email" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Phone</label>
                                    <input type="tel" class="form-control" name="phone">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Department</label>
                                    <input type="text" class="form-control" name="department" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Level</label>
                                    <input type="text" class="form-control" value="<%= level %>" readonly>
                                    <input type="hidden" name="level" value="<%= level %>">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Password</label>
                            <input type="password" class="form-control" name="password" required>
                            <div class="form-text">Default password for the student account</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-person-plus me-1"></i>Add Student
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div class="modal fade" id="editStudentModal" tabindex="-1" aria-modal="true" data-bs-backdrop="static" data-bs-keyboard="false" style="overflow-y:auto;">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <form action="/coordinator/update-student" method="POST">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Student</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="student_id" id="editStudentId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Full Name</label>
                                    <input type="text" class="form-control" name="full_name" id="editStudentName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Student ID</label>
                                    <input type="text" class="form-control" name="student_id" id="editStudentIdNumber" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Email</label>
                                    <input type="email" class="form-control" name="email" id="editStudentEmail" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Phone</label>
                                    <input type="tel" class="form-control" name="phone" id="editStudentPhone">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Department</label>
                                    <input type="text" class="form-control" name="department" id="editStudentDepartment" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Level</label>
                                    <input type="text" class="form-control" value="<%= level %>" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>Update Student
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Assign Modal -->
    <div class="modal fade" id="assignModal" tabindex="-1" aria-modal="true" data-bs-backdrop="static" data-bs-keyboard="false" style="overflow-y:auto;">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <form action="/coordinator/assign-student" method="POST">
                    <div class="modal-header">
                        <h5 class="modal-title">Assign Supervisor</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="studentId" id="studentIdField">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Student</label>
                            <input type="text" id="studentNameField" class="form-control" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Select Supervisor</label>
                            <select class="form-select" name="supervisorId" id="supervisorSelect" required>
                                <option value="">Choose a supervisor...</option>
                                <% if (supervisors && supervisors.length > 0) { 
                                    supervisors.forEach(supervisor => {
                                        const assignedCount = supervisor.assignedStudents || 0;
                                        const maxCapacity = 5; // Default capacity
                                        const available = assignedCount < maxCapacity;
                                %>
                                    <option value="<%= supervisor.id %>" <%= !available ? 'disabled' : '' %>>
                                        <%= supervisor.full_name %> 
                                        (<%= assignedCount %>/<%= maxCapacity %> students)
                                        <%= !available ? ' - FULL' : '' %>
                                    </option>
                                <% }); } %>
                            </select>
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>
                                Supervisors with "FULL" have reached their maximum capacity
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-person-plus me-1"></i>Assign Supervisor
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Student Details Modal -->
    <div class="modal fade" id="studentDetailsModal" tabindex="-1" aria-modal="true" data-bs-backdrop="static" data-bs-keyboard="false" style="overflow-y:auto;">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Student Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="studentDetailsContent">
                    <!-- Details will be loaded via JavaScript -->
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading student details...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap & JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Fix for modal scroll issues/stacking
        document.body.addEventListener('shown.bs.modal', function(e) {
            document.body.style.overflow = 'hidden';
        });
        document.body.addEventListener('hidden.bs.modal', function(e) {
            document.body.style.overflow = '';
        });

        // Filter functionality
        const searchInput = document.getElementById('searchStudents');
        const statusFilter = document.getElementById('statusFilter');
        const departmentFilter = document.getElementById('departmentFilter');
        const resetFilters = document.getElementById('resetFilters');
        const studentItems = document.querySelectorAll('.student-item');

        function filterStudents() {
            const searchTerm = searchInput.value.toLowerCase();
            const statusValue = statusFilter.value;
            const departmentValue = departmentFilter.value;

            studentItems.forEach(item => {
                const name = item.getAttribute('data-name');
                const email = item.getAttribute('data-email');
                const status = item.getAttribute('data-status');
                const department = item.getAttribute('data-department');

                const matchesSearch = name.includes(searchTerm) || email.includes(searchTerm);
                const matchesStatus = statusValue === 'all' || status === statusValue;
                const matchesDepartment = departmentValue === 'all' || department === departmentValue.toLowerCase();

                if (matchesSearch && matchesStatus && matchesDepartment) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        searchInput.addEventListener('input', filterStudents);
        statusFilter.addEventListener('change', filterStudents);
        departmentFilter.addEventListener('change', filterStudents);

        resetFilters.addEventListener('click', function() {
            searchInput.value = '';
            statusFilter.value = 'all';
            departmentFilter.value = 'all';
            filterStudents();
        });

        // Edit student modal
        const editStudentModal = document.getElementById('editStudentModal');
        if (editStudentModal) {
            editStudentModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                document.getElementById('editStudentId').value = button.getAttribute('data-student-id');
                document.getElementById('editStudentName').value = button.getAttribute('data-student-name');
                document.getElementById('editStudentEmail').value = button.getAttribute('data-student-email');
                document.getElementById('editStudentDepartment').value = button.getAttribute('data-student-department');
                document.getElementById('editStudentPhone').value = button.getAttribute('data-student-phone');
                document.getElementById('editStudentIdNumber').value = button.getAttribute('data-student-id-number');
            });
        }

        // Assign modal
        const assignModal = document.getElementById('assignModal');
        if (assignModal) {
            assignModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const studentId = button.getAttribute('data-student-id');
                const studentName = button.getAttribute('data-student-name');
                const currentSupervisor = button.getAttribute('data-current-supervisor');

                document.getElementById('studentIdField').value = studentId;
                document.getElementById('studentNameField').value = studentName;
                
                const modalTitle = assignModal.querySelector('.modal-title');
                modalTitle.textContent = `Assign Supervisor to ${studentName}`;
                
                // Preselect current supervisor if reassigning
                if (currentSupervisor) {
                    document.getElementById('supervisorSelect').value = currentSupervisor;
                } else {
                    document.getElementById('supervisorSelect').value = '';
                }
            });
        }

        // Student details modal
        const studentDetailsModal = document.getElementById('studentDetailsModal');
        if (studentDetailsModal) {
            studentDetailsModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const studentId = button.getAttribute('data-student-id');
                
                // Load student details via AJAX
                fetch(`/coordinator/student-details/${studentId}`)
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById('studentDetailsContent').innerHTML = html;
                    })
                    .catch(error => {
                        document.getElementById('studentDetailsContent').innerHTML = `
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Failed to load student details: ${error.message}
                            </div>
                        `;
                    });
            });
        }

        // Refresh button
        const refreshBtn = document.getElementById('refreshBtn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', function() {
                this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Refreshing...';
                this.disabled = true;
                setTimeout(() => {
                    location.reload();
                }, 1000);
            });
        }

        // Initialize filters
        filterStudents();
    });
    </script>
</body>
</html>