<div class="row mb-4">
  <div class="col-12">
    <h1 class="page-title"><i class="bi bi-gear me-2"></i>Account Settings</h1>
    <p class="page-subtitle">Manage your security preferences and account configuration</p>
  </div>
</div>

<!-- Success/Error Messages -->
<% if (typeof success !== 'undefined' && success) { %>
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="bi bi-check-circle-fill me-2"></i>
    <strong>Success!</strong> <%= success %>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
<% } %>

<% if (typeof error !== 'undefined' && error) { %>
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    <strong>Error!</strong> <%= error %>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
<% } %>

<div class="row">
  <!-- Security Settings -->
  <div class="col-lg-8">
    <!-- Password Management -->
    <div class="card mb-4">
      <div class="card-header bg-white">
        <h5 class="mb-0">
          <i class="bi bi-shield-lock me-2 text-primary"></i>Password Management
        </h5>
      </div>
      <div class="card-body">
        <form id="changePasswordForm" action="/student/change-password" method="POST" autocomplete="off">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="currentPassword" class="form-label">Current Password</label>
              <div class="input-group">
                <input type="password" class="form-control" id="currentPassword" name="currentPassword" autocomplete="current-password" required>
                <button class="btn btn-outline-secondary" type="button" id="toggleCurrentPassword" tabindex="-1" aria-label="Show/Hide Current Password">
                  <i class="bi bi-eye"></i>
                </button>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="newPassword" class="form-label">New Password</label>
              <div class="input-group">
                <input 
                  type="password" 
                  class="form-control" 
                  id="newPassword" 
                  name="newPassword" 
                  required
                  minlength="8"
                  pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$"
                  autocomplete="new-password"
                  aria-describedby="newPasswordHelp"
                >
                <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword" tabindex="-1" aria-label="Show/Hide New Password">
                  <i class="bi bi-eye"></i>
                </button>
              </div>
              <div class="form-text" id="newPasswordHelp">
                Password must contain at least 8 characters including uppercase, lowercase, number, and special character
              </div>
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="confirmPassword" class="form-label">Confirm New Password</label>
              <div class="input-group">
                <input 
                  type="password" 
                  class="form-control" 
                  id="confirmPassword" 
                  name="confirmPassword" 
                  required 
                  autocomplete="new-password"
                >
                <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword" tabindex="-1" aria-label="Show/Hide Confirm Password">
                  <i class="bi bi-eye"></i>
                </button>
              </div>
              <div id="passwordMatch" class="form-text"></div>
            </div>
          </div>
          
          <!-- Password Strength Meter -->
          <div class="mb-3">
            <label class="form-label">Password Strength</label>
            <div class="progress mb-2" style="height: 8px;">
              <div class="progress-bar" id="passwordStrength" role="progressbar" style="width: 0%;"></div>
            </div>
            <div id="passwordFeedback" class="form-text small"></div>
          </div>
          
          <div class="d-flex justify-content-between align-items-center">
            <button type="submit" class="btn btn-primary" id="updatePasswordBtn">
              <i class="bi bi-key me-1"></i>Update Password
            </button>
            <a href="#" class="text-muted small" data-bs-toggle="modal" data-bs-target="#forgotPasswordModal" tabindex="0">
              Forgot your password?
            </a>
          </div>
        </form>
      </div>
    </div>

    <!-- Multi-Factor Authentication -->
    <div class="card mb-4">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="bi bi-shield-check me-2 text-primary"></i>Multi-Factor Authentication
        </h5>
        <span class="badge <%= mfaEnabled ? 'bg-success' : 'bg-secondary' %>">
          <%= mfaEnabled ? 'ENABLED' : 'DISABLED' %>
        </span>
      </div>
      <div class="card-body">
        <% if (!mfaEnabled) { %>
          <!-- MFA Setup -->
          <div class="mfa-setup">
            <div class="row align-items-center">
              <div class="col-md-8">
                <h6>Enable Two-Factor Authentication</h6>
                <p class="text-muted small mb-3">
                  Add an extra layer of security to your account by enabling two-factor authentication. 
                  You'll need to enter a verification code from your authenticator app when signing in.
                </p>
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#setupMfaModal" type="button">
                    <i class="bi bi-qr-code me-1"></i>Setup with Google Authenticator
                  </button>
                  <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#setupMfaModal" type="button">
                    <i class="bi bi-microsoft me-1"></i>Setup with Microsoft Authenticator
                  </button>
                </div>
              </div>
              <div class="col-md-4 text-center">
                <div class="bg-light rounded-3 p-3">
                  <i class="bi bi-shield-check display-4 text-muted"></i>
                </div>
              </div>
            </div>
          </div>
        <% } else { %>
          <!-- MFA Enabled -->
          <div class="mfa-enabled">
            <div class="row align-items-center">
              <div class="col-md-8">
                <h6 class="text-success">
                  <i class="bi bi-check-circle me-2"></i>Two-Factor Authentication Enabled
                </h6>
                <p class="text-muted small mb-3">
                  Your account is protected with two-factor authentication. 
                  You'll need to enter a verification code from your authenticator app when signing in.
                </p>
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-warning btn-sm" data-bs-toggle="modal" data-bs-target="#recoveryCodesModal" type="button">
                    <i class="bi bi-key me-1"></i>View Recovery Codes
                  </button>
                  <button class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#disableMfaModal" type="button">
                    <i class="bi bi-x-circle me-1"></i>Disable MFA
                  </button>
                </div>
              </div>
              <div class="col-md-4 text-center">
                <div class="bg-success bg-opacity-10 rounded-3 p-3">
                  <i class="bi bi-shield-check display-4 text-success"></i>
                </div>
              </div>
            </div>
            
            <!-- MFA Devices -->
            <div class="mt-4">
              <h6>Registered Authenticator Apps</h6>
              <div class="list-group">
                <div class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <i class="bi bi-phone me-2"></i>
                    <span>Google Authenticator</span>
                    <br>
                    <small class="text-muted">Added on <%= typeof mfaDeviceAdded === 'string' ? mfaDeviceAdded : new Date().toLocaleDateString() %></small>
                  </div>
                  <span class="badge bg-success">Active</span>
                </div>
              </div>
            </div>
          </div>
        <% } %>
      </div>
    </div>

    <!-- Session Management -->
    <div class="card">
      <div class="card-header bg-white">
        <h5 class="mb-0">
          <i class="bi bi-laptop me-2 text-primary"></i>Session Management
        </h5>
      </div>
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h6>Current Session</h6>
            <p class="text-muted small mb-0">
              <i class="bi bi-info-circle me-1"></i>
              You're currently signed in on this device
            </p>
          </div>
          <span class="badge bg-success">Active</span>
        </div>
        
        <div class="session-info bg-light rounded-3 p-3 mb-3">
          <div class="row">
            <div class="col-sm-6">
              <small class="text-muted">Device</small>
              <div class="fw-semibold"><%= typeof device === 'string' ? device : 'Unknown Device' %></div>
            </div>
            <div class="col-sm-6">
              <small class="text-muted">Location</small>
              <div class="fw-semibold"><%= typeof location === 'string' ? location : 'Unknown Location' %></div>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-sm-6">
              <small class="text-muted">IP Address</small>
              <div class="fw-semibold"><%= typeof ip === 'string' ? ip : 'Unknown IP' %></div>
            </div>
            <div class="col-sm-6">
              <small class="text-muted">Last Active</small>
              <div class="fw-semibold"><%= typeof lastActive === 'string' ? lastActive : new Date().toLocaleString() %></div>
            </div>
          </div>
        </div>
        
        <button class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#signOutAllModal" type="button">
          <i class="bi bi-box-arrow-right me-1"></i>Sign Out All Other Sessions
        </button>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="col-lg-4">
    <!-- Security Summary -->
    <div class="card mb-4">
      <div class="card-header bg-white">
        <h6 class="mb-0">
          <i class="bi bi-graph-up me-2 text-primary"></i>Security Score
        </h6>
      </div>
      <div class="card-body">
        <div class="security-score text-center mb-3">
          <div class="score-circle mx-auto mb-3" id="scoreCircle" data-score="<%= typeof calculateSecurityScore === 'function' ? calculateSecurityScore(mfaEnabled) : 70 %>">
            <span class="score-text"><%= typeof calculateSecurityScore === 'function' ? calculateSecurityScore(mfaEnabled) : 70 %>%</span>
          </div>
          <h6>Account Security</h6>
          <p class="text-muted small">
            <%= typeof getSecurityMessage === 'function' ? getSecurityMessage(typeof calculateSecurityScore === 'function' ? calculateSecurityScore(mfaEnabled) : 70) : '' %>
          </p>
        </div>
        
        <div class="security-checklist">
          <div class="checklist-item mb-2 <%= mfaEnabled ? 'completed' : '' %>">
            <i class="bi <%= mfaEnabled ? 'bi-check-circle text-success' : 'bi-circle text-muted' %> me-2"></i>
            <span>Two-Factor Authentication</span>
          </div>
          <div class="checklist-item mb-2 completed">
            <i class="bi bi-check-circle text-success me-2"></i>
            <span>Strong Password</span>
          </div>
          <div class="checklist-item mb-2 completed">
            <i class="bi bi-check-circle text-success me-2"></i>
            <span>Recent Password Change</span>
          </div>
          <div class="checklist-item completed">
            <i class="bi bi-check-circle text-success me-2"></i>
            <span>Active Session</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="card mb-4">
      <div class="card-header bg-white">
        <h6 class="mb-0">
          <i class="bi bi-lightning me-2 text-primary"></i>Quick Actions
        </h6>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <a href="/student/profile" class="btn btn-outline-primary">
            <i class="bi bi-person me-2"></i>Edit Profile
          </a>
          <a href="/student/dashboard" class="btn btn-outline-secondary">
            <i class="bi bi-speedometer2 me-2"></i>Back to Dashboard
          </a>
        </div>
      </div>
    </div>

    <!-- Security Tips -->
    <div class="card">
      <div class="card-header bg-white">
        <h6 class="mb-0">
          <i class="bi bi-info-circle me-2 text-primary"></i>Security Tips
        </h6>
      </div>
      <div class="card-body">
        <div class="security-tips">
          <div class="tip-item mb-3">
            <i class="bi bi-shield-check text-success me-2"></i>
            <small>Enable two-factor authentication for extra security</small>
          </div>
          <div class="tip-item mb-3">
            <i class="bi bi-arrow-repeat text-primary me-2"></i>
            <small>Change your password every 90 days</small>
          </div>
          <div class="tip-item">
            <i class="bi bi-eye-slash text-warning me-2"></i>
            <small>Never share your password or verification codes</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MFA Setup Modal -->
<div class="modal fade" id="setupMfaModal" tabindex="-1" aria-labelledby="setupMfaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="setupMfaModalLabel">
          <i class="bi bi-qr-code me-2"></i>Setup Two-Factor Authentication
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6 text-center">
            <div class="mb-4">
              <div id="mfaQrCode" class="qr-code-placeholder bg-light rounded-3 p-4 mx-auto mb-3" style="width: 200px; height: 200px;">
                <i class="bi bi-qr-code display-4 text-muted"></i>
              </div>
              <p class="small text-muted" id="mfaQrCodeDescription">Scan this QR code with your authenticator app</p>
            </div>
          </div>
          <div class="col-md-6">
            <h6>Setup Instructions</h6>
            <ol class="small">
              <li class="mb-2">Install Google Authenticator or Microsoft Authenticator</li>
              <li class="mb-2">Open the app and tap "Add account"</li>
              <li class="mb-2">Choose "Scan a QR code"</li>
              <li class="mb-2">Point your camera at the QR code</li>
              <li>Enter the 6-digit code below to verify</li>
            </ol>
            
            <form id="verifyMfaForm" autocomplete="off">
              <div class="mb-3">
                <label class="form-label" for="mfaVerificationCode">Enter 6-digit verification code</label>
                <input type="text" class="form-control text-center" id="mfaVerificationCode" name="mfaVerificationCode" maxlength="6" pattern="[0-9]{6}" placeholder="123456" inputmode="numeric" style="font-size: 1.5rem; letter-spacing: 0.5rem;">
              </div>
              <div class="d-grid">
                <button type="submit" class="btn btn-primary">Verify and Enable</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Recovery Codes Modal -->
<div class="modal fade" id="recoveryCodesModal" tabindex="-1" aria-labelledby="recoveryCodesModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="recoveryCodesModalLabel">
          <i class="bi bi-key me-2"></i>Recovery Codes
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Save these codes in a secure place. You can use them to access your account if you lose your authenticator device.
        </div>
        
        <div class="recovery-codes bg-light rounded-3 p-3 mb-3">
          <div class="row text-center fw-bold" id="recoveryCodesList">
            <% if (typeof recoveryCodes !== 'undefined' && Array.isArray(recoveryCodes)) { %>
              <% recoveryCodes.forEach(function(code) { %>
                <div class="col-6 mb-2"><%= code %></div>
              <% }); %>
            <% } else { %>
              <div class="col-6 mb-2">1A2B3C4D5E</div>
              <div class="col-6 mb-2">6F7G8H9I0J</div>
              <div class="col-6 mb-2">K1L2M3N4O5</div>
              <div class="col-6 mb-2">P6Q7R8S9T0</div>
              <div class="col-6">U1V2W3X4Y5</div>
              <div class="col-6">Z6A7B8C9D0</div>
            <% } %>
          </div>
        </div>
        
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="downloadRecoveryCodes()">
            <i class="bi bi-download me-1"></i>Download
          </button>
          <button class="btn btn-outline-secondary btn-sm" type="button" onclick="printRecoveryCodes()">
            <i class="bi bi-printer me-1"></i>Print
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Disable MFA Modal -->
<div class="modal fade" id="disableMfaModal" tabindex="-1" aria-labelledby="disableMfaModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-danger" id="disableMfaModalLabel">
          <i class="bi bi-x-circle me-2"></i>Disable Two-Factor Authentication
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Are you sure you want to disable two-factor authentication? This will reduce your account security.
        </div>
        
        <form id="disableMfaForm" autocomplete="off" onsubmit="return false;">
          <div class="mb-3">
            <label class="form-label" for="disableMfaPassword">Enter your password to confirm</label>
            <input type="password" class="form-control" id="disableMfaPassword" name="disableMfaPassword" required autocomplete="current-password">
          </div>
          <div class="mb-3">
            <label class="form-label" for="disableMfaCode">Enter verification code</label>
            <input type="text" class="form-control" id="disableMfaCode" name="disableMfaCode" maxlength="6" pattern="[0-9]{6}" placeholder="123456" required inputmode="numeric">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="disableMFA()">Disable MFA</button>
      </div>
    </div>
  </div>
</div>

<!-- EJS Helper Functions -->
<script>
  function calculateSecurityScore(mfaEnabled) {
    let score = 70;
    if (mfaEnabled) score += 30;
    return score;
  }
  function getSecurityMessage(score) {
    if (score >= 90) return 'Excellent security';
    if (score >= 70) return 'Good security';
    return 'Needs improvement';
  }
</script>

<style>
  .score-circle {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: conic-gradient(var(--buk-success) 0%, var(--buk-success) calc(var(--score, 0) * 1%), #e9ecef calc(var(--score, 0) * 1%) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }
  .score-circle::before {
    content: '';
    position: absolute;
    width: 80px;
    height: 80px;
    background: white;
    border-radius: 50%;
    z-index: 1;
  }
  .score-text {
    position: relative;
    font-size: 1.25rem;
    font-weight: bold;
    color: var(--buk-success);
    z-index: 2;
  }
  .security-checklist .completed {
    color: var(--buk-success);
  }
  .qr-code-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .recovery-codes {
    font-family: 'Courier New', monospace;
    user-select: all;
  }
  .session-info {
    border-left: 4px solid var(--buk-success);
  }
  .checklist-item.completed {
    color: var(--buk-success);
  }
</style>

<script>
  // Password visibility toggles
  ['Current', 'New', 'Confirm'].forEach(field => {
    const toggleBtn = document.getElementById(`toggle${field}Password`);
    const input = document.getElementById(`${field.toLowerCase()}Password`);
    if (toggleBtn && input) {
      toggleBtn.addEventListener('click', function() {
        if (input.type === "password") {
          input.type = "text";
          toggleBtn.querySelector('i').classList.remove('bi-eye');
          toggleBtn.querySelector('i').classList.add('bi-eye-slash');
        } else {
          input.type = "password";
          toggleBtn.querySelector('i').classList.remove('bi-eye-slash');
          toggleBtn.querySelector('i').classList.add('bi-eye');
        }
      });
    }
  });

  // Password match check
  const newPassword = document.getElementById('newPassword');
  const confirmPassword = document.getElementById('confirmPassword');
  const passwordMatch = document.getElementById('passwordMatch');
  if (newPassword && confirmPassword && passwordMatch) {
    function checkPasswordMatch() {
      if (!confirmPassword.value) {
        passwordMatch.textContent = '';
        return;
      }
      if (newPassword.value === confirmPassword.value) {
        passwordMatch.textContent = 'Passwords match';
        passwordMatch.style.color = 'green';
      } else {
        passwordMatch.textContent = 'Passwords do not match';
        passwordMatch.style.color = 'red';
      }
    }
    newPassword.addEventListener('input', checkPasswordMatch);
    confirmPassword.addEventListener('input', checkPasswordMatch);
  }

  // Password strength meter
  const strengthBar = document.getElementById('passwordStrength');
  const passwordFeedback = document.getElementById('passwordFeedback');
  if (newPassword && strengthBar && passwordFeedback) {
    newPassword.addEventListener('input', function() {
      const val = newPassword.value;
      let score = 0;
      if (val.length >= 8) score += 1;
      if (/[a-z]/.test(val)) score += 1;
      if (/[A-Z]/.test(val)) score += 1;
      if (/\d/.test(val)) score += 1;
      if (/[@$!%*?&]/.test(val)) score += 1;

      let percent = (score / 5) * 100;
      strengthBar.style.width = percent + "%";
      strengthBar.className = "progress-bar";
      if (score <= 2) {
        strengthBar.classList.add("bg-danger");
        passwordFeedback.textContent = 'Weak password';
      } else if (score <= 4) {
        strengthBar.classList.add("bg-warning");
        passwordFeedback.textContent = 'Moderate password';
      } else {
        strengthBar.classList.add("bg-success");
        passwordFeedback.textContent = 'Strong password';
      }
    });
  }

  // Security score circle JS (set conic-gradient percentage)
  document.addEventListener('DOMContentLoaded', function() {
    const scoreCircle = document.getElementById("scoreCircle");
    if (scoreCircle && scoreCircle.dataset.score) {
      const percent = parseInt(scoreCircle.dataset.score, 10);
      // Set inline variable for dynamic score coloring
      scoreCircle.style.setProperty('--score', percent);
    }
  });

  // Download/Print Recovery Codes (implementations are placeholders)
  function downloadRecoveryCodes() {
    const codeEls = Array.from(document.querySelectorAll('#recoveryCodesList .col-6'));
    const codes = codeEls.map(el => el.textContent.trim()).join('\n');
    const blob = new Blob([codes], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'recovery-codes.txt';
    a.click();
    URL.revokeObjectURL(url);
  }
  function printRecoveryCodes() {
    const codeEls = Array.from(document.querySelectorAll('#recoveryCodesList .col-6'));
    const codes = codeEls.map(el => el.textContent.trim()).join('\n');
    const printWindow = window.open('', '', 'width=400,height=600');
    printWindow.document.write('<pre>' + codes + '</pre>');
    printWindow.document.close();
    printWindow.print();
  }

  // Disable MFA dummy (replace with AJAX/real logic)
  function disableMFA() {
    const pass = document.getElementById('disableMfaPassword').value;
    const code = document.getElementById('disableMfaCode').value;
    if (!pass || !code) {
      alert('Please provide password and code.');
      return false;
    }
    // You'd submit the form via AJAX here.
    alert('MFA disabled (demo).');
    document.getElementById('disableMfaForm').reset();
    var modal = bootstrap.Modal.getInstance(document.getElementById('disableMfaModal'));
    if (modal) modal.hide();
  }
</script>