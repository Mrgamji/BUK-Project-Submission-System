<div class="row mb-4">
    <div class="col-12">
      <h1 class="page-title"><i class="bi bi-person-circle me-2"></i>My Profile</h1>
      <p class="page-subtitle">Manage your personal information and account settings</p>
    </div>
  </div>
  
  <!-- Success/Error Messages -->
  <% if (success) { %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <i class="bi bi-check-circle-fill me-2"></i>
      <strong>Success!</strong> <%= success %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% } %>
  
  <% if (error) { %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      <strong>Error!</strong> <%= error %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% } %>
  
  <div class="row">
    <!-- Profile Information -->
    <div class="col-lg-8">
      <div class="card mb-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-person-badge me-2 text-primary"></i>Personal Information
          </h5>
          <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editProfileModal">
            <i class="bi bi-pencil me-1"></i>Edit Profile
          </button>
        </div>
        <div class="card-body">
          <div class="row">
            <!-- Profile Picture -->
            <div class="col-md-3 text-center mb-4 mb-md-0">
              <div class="profile-avatar mx-auto mb-3">
                <div class="avatar-placeholder bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto" style="width: 120px; height: 120px; font-size: 2.5rem;">
                  <i class="bi bi-person-fill"></i>
                </div>
              </div>
              <button class="btn btn-outline-secondary btn-sm w-100">
                <i class="bi bi-camera me-1"></i>Change Photo
              </button>
            </div>
            
            <!-- Personal Details -->
            <div class="col-md-9">
              <div class="row g-3">
                <div class="col-sm-6">
                  <div class="info-item">
                    <i class="bi bi-person-fill text-primary me-2"></i>
                    <strong>Full Name</strong>
                    <div class="mt-1"><%= user.full_name %></div>
                  </div>
                </div>
                
                <div class="col-sm-6">
                  <div class="info-item">
                    <i class="bi bi-envelope-fill text-primary me-2"></i>
                    <strong>Email Address</strong>
                    <div class="mt-1"><%= user.email %></div>
                  </div>
                </div>
                
                <div class="col-sm-6">
                  <div class="info-item">
                    <i class="bi bi-person-badge text-primary me-2"></i>
                    <strong>Registration Number</strong>
                    <div class="mt-1"><%= user.registration_number || 'Not provided' %></div>
                  </div>
                </div>
                
                <div class="col-sm-6">
                  <div class="info-item">
                    <i class="bi bi-building text-primary me-2"></i>
                    <strong>Department</strong>
                    <div class="mt-1"><%= user.department || 'Not specified' %></div>
                  </div>
                </div>
                
                <div class="col-sm-6">
                  <div class="info-item">
                    <i class="bi bi-mortarboard text-primary me-2"></i>
                    <strong>Level</strong>
                    <div class="mt-1"><%= user.level || 'Not specified' %></div>
                  </div>
                </div>
                
                <div class="col-sm-6">
                  <div class="info-item">
                    <i class="bi bi-shield-check text-primary me-2"></i>
                    <strong>Account Status</strong>
                    <div class="mt-1">
                      <% if (user.is_active) { %>
                        <span class="badge bg-success">Active</span>
                      <% } else { %>
                        <span class="badge bg-danger">Inactive</span>
                      <% } %>
                    </div>
                  </div>
                </div>
                
                <div class="col-12">
                  <div class="info-item">
                    <i class="bi bi-calendar-check text-primary me-2"></i>
                    <strong>Member Since</strong>
                    <div class="mt-1"><%= new Date(user.created_at).toLocaleDateString() %></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
  
      <!-- Academic Progress -->
      <div class="card mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="bi bi-graph-up me-2 text-primary"></i>Academic Progress
          </h5>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-md-3 mb-3">
              <div class="stat-card p-3 rounded-3 bg-light">
                <div class="stat-value text-primary"><%= reports ? reports.length : 0 %></div>
                <div class="stat-label">Total Reports</div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="stat-card p-3 rounded-3 bg-light">
                <div class="stat-value text-success">
                  <%= reports ? reports.filter(r => r.status === 'approved').length : 0 %>
                </div>
                <div class="stat-label">Approved</div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="stat-card p-3 rounded-3 bg-light">
                <div class="stat-value text-warning">
                  <%= reports ? reports.filter(r => r.status === 'pending').length : 0 %>
                </div>
                <div class="stat-label">Pending</div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="stat-card p-3 rounded-3 bg-light">
                <div class="stat-value text-info">
                  <%= reports ? reports.filter(r => r.status === 'feedback_given').length : 0 %>
                </div>
                <div class="stat-label">With Feedback</div>
              </div>
            </div>
          </div>
          
          <!-- Progress by Stage -->
          <div class="mt-4">
            <h6 class="mb-3">Reports by Stage</h6>
            <div class="progress-stages">
              <% 
                const stages = [
                  { key: 'progress_1', name: 'Progress 1', color: 'primary' },
                  { key: 'progress_2', name: 'Progress 2', color: 'info' },
                  { key: 'progress_3', name: 'Progress 3', color: 'warning' },
                  { key: 'final', name: 'Final', color: 'success' }
                ];
              %>
              <% stages.forEach(stage => { %>
                <div class="progress-stage-item mb-3">
                  <div class="d-flex justify-content-between mb-1">
                    <span class="fw-semibold"><%= stage.name %></span>
                    <span class="text-muted">
                      <%= reportsByStage[stage.key] ? reportsByStage[stage.key].length : 0 %> submitted
                    </span>
                  </div>
                  <div class="progress" style="height: 8px;">
                    <div 
                      class="progress-bar bg-<%= stage.color %>" 
                      role="progressbar" 
                      style="width: <%= (reportsByStage[stage.key] ? reportsByStage[stage.key].length : 0) * 25 %>%"
                      aria-valuenow="<%= (reportsByStage[stage.key] ? reportsByStage[stage.key].length : 0) * 25 %>" 
                      aria-valuemin="0" 
                      aria-valuemax="100">
                    </div>
                  </div>
                </div>
              <% }); %>
            </div>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Sidebar Actions -->
    <div class="col-lg-4">
      <!-- Quick Actions -->
      <div class="card mb-4">
        <div class="card-header bg-white">
          <h6 class="mb-0">
            <i class="bi bi-lightning me-2 text-primary"></i>Quick Actions
          </h6>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <a href="/student/dashboard" class="btn btn-outline-primary">
              <i class="bi bi-speedometer2 me-2"></i>Dashboard
            </a>
            <a href="/student/upload-report" class="btn btn-outline-success">
              <i class="bi bi-cloud-upload me-2"></i>Upload Report
            </a>
            <a href="/student/supervisor" class="btn btn-outline-info">
              <i class="bi bi-person-workspace me-2"></i>My Supervisor
            </a>
            <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
              <i class="bi bi-key me-2"></i>Change Password
            </button>
          </div>
        </div>
      </div>
  
      <!-- Account Information -->
      <div class="card mb-4">
        <div class="card-header bg-white">
          <h6 class="mb-0">
            <i class="bi bi-info-circle me-2 text-primary"></i>Account Information
          </h6>
        </div>
        <div class="card-body">
          <div class="account-info">
            <div class="info-item small mb-2">
              <strong>User ID:</strong> <span class="text-muted"><%= user.id %></span>
            </div>
            <div class="info-item small mb-2">
              <strong>Role:</strong> <span class="badge bg-secondary"><%= user.role.replace('_', ' ').toUpperCase() %></span>
            </div>
            <div class="info-item small mb-2">
              <strong>Last Login:</strong> <span class="text-muted"><%= new Date().toLocaleString() %></span>
            </div>
            <div class="info-item small">
              <strong>Profile Updated:</strong> <span class="text-muted"><%= new Date(user.updated_at).toLocaleDateString() %></span>
            </div>
          </div>
        </div>
      </div>
  
      <!-- Support Card -->
      <div class="card">
        <div class="card-header bg-white">
          <h6 class="mb-0">
            <i class="bi bi-headset me-2 text-primary"></i>Need Help?
          </h6>
        </div>
        <div class="card-body">
          <p class="small text-muted mb-3">
            Having issues with your account or need assistance?
          </p>
          <div class="d-grid gap-2">
            <button class="btn btn-outline-secondary btn-sm">
              <i class="bi bi-question-circle me-2"></i>Help Center
            </button>
            <button class="btn btn-outline-secondary btn-sm">
              <i class="bi bi-envelope me-2"></i>Contact Support
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Edit Profile Modal -->
  <div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-pencil-square me-2"></i>Edit Profile
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editProfileForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Full Name</label>
                <input type="text" class="form-control" name="full_name" value="<%= user.full_name %>" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Email Address</label>
                <input type="email" class="form-control" value="<%= user.email %>" disabled>
                <small class="text-muted">Contact administrator to change email</small>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Registration Number</label>
                <input type="text" class="form-control" name="registration_number" value="<%= user.registration_number || '' %>">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Department</label>
                <input type="text" class="form-control" name="department" value="<%= user.department || '' %>">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Level</label>
                <select class="form-select" name="level">
                  <option value="">Select Level</option>
                  <option value="100" <%= user.level === '100' ? 'selected' : '' %>>100 Level</option>
                  <option value="200" <%= user.level === '200' ? 'selected' : '' %>>200 Level</option>
                  <option value="300" <%= user.level === '300' ? 'selected' : '' %>>300 Level</option>
                  <option value="400" <%= user.level === '400' ? 'selected' : '' %>>400 Level</option>
                  <option value="500" <%= user.level === '500' ? 'selected' : '' %>>500 Level</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Phone Number</label>
                <input type="tel" class="form-control" name="phone" value="<%= user.phone || '' %>">
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="updateProfile()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Change Password Modal -->
  <div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-key me-2"></i>Change Password
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="changePasswordForm">
            <div class="mb-3">
              <label class="form-label">Current Password</label>
              <input type="password" class="form-control" name="current_password" required>
            </div>
            <div class="mb-3">
              <label class="form-label">New Password</label>
              <input type="password" class="form-control" name="new_password" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Confirm New Password</label>
              <input type="password" class="form-control" name="confirm_password" required>
            </div>
            <div class="form-text">
              Password must be at least 8 characters long and include uppercase, lowercase, and numbers.
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="changePassword()">Update Password</button>
        </div>
      </div>
    </div>
  </div>
  
  <style>
    .profile-avatar .avatar-placeholder {
      background: linear-gradient(135deg, var(--buk-blue) 0%, #004080 100%);
    }
  
    .info-item {
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid var(--buk-blue);
      margin-bottom: 0.5rem;
    }
  
    .stat-card {
      transition: transform 0.2s;
    }
  
    .stat-card:hover {
      transform: translateY(-2px);
    }
  
    .stat-value {
      font-size: 1.75rem;
      font-weight: bold;
      margin-bottom: 0.25rem;
    }
  
    .stat-label {
      font-size: 0.875rem;
      color: #6c757d;
      font-weight: 500;
    }
  
    .progress-stage-item {
      padding: 0.5rem;
    }
  
    .account-info .info-item {
      padding: 0.5rem;
      background: transparent;
      border-left: none;
      margin-bottom: 0.25rem;
    }
  
    @media (max-width: 768px) {
      .profile-avatar {
        margin-bottom: 1.5rem;
      }
      
      .stat-value {
        font-size: 1.5rem;
      }
    }
  </style>
  
  <script>
    function updateProfile() {
      // Simulate profile update
      const form = document.getElementById('editProfileForm');
      const formData = new FormData(form);
      
      // Show loading state
      const saveBtn = document.querySelector('#editProfileModal .btn-primary');
      const originalText = saveBtn.innerHTML;
      saveBtn.innerHTML = '<i class="bi bi-arrow-repeat spinner-border spinner-border-sm me-2"></i>Saving...';
      saveBtn.disabled = true;
  
      // Simulate API call
      setTimeout(() => {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
        modal.hide();
        
        // Show success message (in real app, this would come from server)
        showAlert('Profile updated successfully!', 'success');
      }, 1500);
    }
  
    function changePassword() {
      const form = document.getElementById('changePasswordForm');
      const formData = new FormData(form);
      
      const newPassword = formData.get('new_password');
      const confirmPassword = formData.get('confirm_password');
      
      if (newPassword !== confirmPassword) {
        showAlert('New passwords do not match!', 'error');
        return;
      }
      
      if (newPassword.length < 8) {
        showAlert('Password must be at least 8 characters long!', 'error');
        return;
      }
  
      // Show loading state
      const saveBtn = document.querySelector('#changePasswordModal .btn-primary');
      const originalText = saveBtn.innerHTML;
      saveBtn.innerHTML = '<i class="bi bi-arrow-repeat spinner-border spinner-border-sm me-2"></i>Updating...';
      saveBtn.disabled = true;
  
      // Simulate API call
      setTimeout(() => {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
        modal.hide();
        
        // Clear form
        form.reset();
        
        // Show success message
        showAlert('Password updated successfully!', 'success');
      }, 1500);
    }
  
    function showAlert(message, type) {
      // Create alert element
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type === 'error' ? 'danger' : 'success'} alert-dismissible fade show`;
      alertDiv.innerHTML = `
        <i class="bi bi-${type === 'error' ? 'exclamation-triangle' : 'check-circle'}-fill me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      // Insert at the top of the page
      const container = document.querySelector('.row.mb-4');
      container.parentNode.insertBefore(alertDiv, container);
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        if (alertDiv.parentNode) {
          alertDiv.remove();
        }
      }, 5000);
    }
  </script>