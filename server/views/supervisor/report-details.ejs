<div class="container-fluid">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="page-title mb-1">
            <i class="bi bi-file-earmark-text me-2"></i>Report Review
          </h1>
          <p class="page-subtitle mb-0">Review and provide feedback for student report</p>
        </div>
        <div class="text-end">
          <a href="/supervisor/reports" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Back to Reports
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Alert Messages -->
  <% if (typeof success !== 'undefined' && success) { %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <i class="bi bi-check-circle-fill me-2"></i><%= success %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% } %>
  
  <% if (typeof error !== 'undefined' && error) { %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="bi bi-exclamation-triangle-fill me-2"></i><%= error %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% } %>

  <div class="row">
    <!-- Main Report Content -->
    <div class="col-lg-8 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
          <h5 class="mb-0 fw-semibold">
            <i class="bi bi-clipboard-data me-2"></i>Report Overview
          </h5>
          <% if (typeof nextStage !== 'undefined' && nextStage) { %>
            <button id="moveNextStageBtn" class="btn btn-light btn-sm shadow">  
              <i class="bi bi-arrow-right-circle me-1"></i>Advance to <%= nextStage.replace('_', ' ').toUpperCase() %>
            </button>
          <% } %>
        </div>
        <div class="card-body">
          <% if (typeof report !== 'undefined') { %>
            <div class="row mb-4">
              <div class="col-md-6">
                <h6 class="fw-semibold text-muted mb-2">Report Information</h6>
                <table class="table table-sm table-borderless">
                  <tr>
                    <td class="text-muted" style="width: 120px;">Title:</td>
                    <td class="fw-semibold"><%= report.title %></td>
                  </tr>
                  <tr>
                    <td class="text-muted">Stage:</td>
                    <td>
                      <span class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25">
                        <%= report.report_stage.replace('_', ' ').toUpperCase() %>
                      </span>
                    </td>
                  </tr>
                  <tr>
                    <td class="text-muted">Status:</td>
                    <td>
                      <% if (report.status === 'pending') { %>
                        <span class="badge bg-warning text-dark">
                          <i class="bi bi-clock me-1"></i>Pending Review
                        </span>
                      <% } else if (report.status === 'approved') { %>
                        <span class="badge bg-success">
                          <i class="bi bi-check-circle me-1"></i>Approved
                        </span>
                      <% } else if (report.status === 'rejected') { %>
                        <span class="badge bg-danger">
                          <i class="bi bi-x-circle me-1"></i>Rejected
                        </span>
                      <% } else { %>
                        <span class="badge bg-info">
                          <i class="bi bi-chat-text me-1"></i>Feedback Given
                        </span>
                      <% } %>
                    </td>
                  </tr>
                  <tr>
                    <td class="text-muted">Submitted:</td>
                    <td><%= new Date(report.submitted_at).toLocaleString() %></td>
                  </tr>
                  <tr>
                    <td class="text-muted">Last Updated:</td>
                    <td><%= new Date(report.updated_at).toLocaleString() %></td>
                  </tr>
                </table>
              </div>
              <div class="col-md-6">
                <h6 class="fw-semibold text-muted mb-2">Student Information</h6>
                <table class="table table-sm table-borderless">
                  <tr>
                    <td class="text-muted" style="width: 120px;">Name:</td>
                    <td class="fw-semibold"><%= report.student_name %></td>
                  </tr>
                  <tr>
                    <td class="text-muted">Email:</td>
                    <td><%= report.student_email %></td>
                  </tr>
                  <tr>
                    <td class="text-muted">Version:</td>
                    <td>v<%= report.version || 1 %></td>
                  </tr>
                </table>
              </div>
            </div>

            <!-- File Information -->
            <div class="mb-4">
              <h6 class="fw-semibold text-muted mb-3">Report File</h6>
              <div class="d-flex gap-2">
                <% if (report.file_url) { %>
                  <a href="/supervisor/files/download/<%= report.id %>" class="btn btn-primary">
                    <i class="bi bi-download me-1"></i>Download Report
                  </a>
                  <a href="/supervisor/files/view/<%= report.id %>" class="btn btn-outline-primary">
                    <i class="bi bi-eye me-1"></i>View File
                  </a>
                  <button class="btn btn-outline-secondary" id="fileInfoBtn" data-report-id="<%= report.id %>">
                    <i class="bi bi-info-circle me-1"></i>File Info
                  </button>
                <% } else { %>
                  <span class="text-muted">No file uploaded for this report</span>
                <% } %>
              </div>
            </div>

            <!-- Quick Actions -->
            <% if (report.status === 'pending') { %>
              <div class="mb-4">
                <h6 class="fw-semibold text-muted mb-3">Quick Actions</h6>
                <div class="d-flex gap-2">
                  <button class="btn btn-success" onclick="approveReport(<%= report.id %>)">
                    <i class="bi bi-check-circle me-1"></i>Approve Report
                  </button>
                  <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#feedbackModal">
                    <i class="bi bi-chat-text me-1"></i>Provide Feedback
                  </button>
                </div>
              </div>
            <% } %>
          <% } else { %>
            <div class="text-center py-4">
              <i class="bi bi-exclamation-triangle display-4 text-muted opacity-25 mb-3"></i>
              <p class="text-muted">Report information not available</p>
            </div>
          <% } %>
        </div>
      </div>
    </div>

    <!-- Sidebar - Feedback and Actions -->
    <div class="col-lg-4 mb-4">
      <!-- Feedback Section -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-0 py-3">
          <h5 class="mb-0 fw-semibold">
            <i class="bi bi-chat-text me-2"></i>Feedback History
            <span class="badge bg-primary ms-2"><%= typeof feedback !== 'undefined' ? feedback.length : 0 %></span>
          </h5>
        </div>
        <div class="card-body">
          <% if (typeof feedback !== 'undefined' && feedback.length > 0) { %>
            <div class="list-group list-group-flush">
              <% feedback.forEach(item => { %>
                <div class="list-group-item border-0 px-0 py-3">
                  <div class="d-flex align-items-start mb-2">
                    <div class="flex-shrink-0">
                      <i class="bi bi-person-circle text-muted fs-5"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                      <h6 class="fw-semibold mb-1"><%= item.supervisor_name %></h6>
                      <p class="small text-muted mb-2">
                        <%= new Date(item.created_at).toLocaleString() %>
                      </p>
                      <p class="mb-2"><%= item.comment %></p>
                      <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-light text-dark border">
                          <i class="bi bi-gear me-1"></i><%= item.action_taken %>
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              <% }); %>
            </div>
          <% } else { %>
            <div class="text-center py-3">
              <i class="bi bi-chat-text display-6 text-muted opacity-25 mb-2"></i>
              <p class="text-muted small">No feedback provided yet</p>
            </div>
          <% } %>
        </div>
      </div>

      <!-- HOD Feedback Section -->
      <% if (typeof hodFeedback !== 'undefined' && hodFeedback.length > 0) { %>
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-white border-0 py-3">
            <h5 class="mb-0 fw-semibold">
              <i class="bi bi-star me-2"></i>HOD Feedback
              <span class="badge bg-warning ms-2"><%= hodFeedback.length %></span>
            </h5>
          </div>
          <div class="card-body">
            <div class="list-group list-group-flush">
              <% hodFeedback.forEach(item => { %>
                <div class="list-group-item border-0 px-0 py-3">
                  <div class="d-flex align-items-start mb-2">
                    <div class="flex-shrink-0">
                      <i class="bi bi-person-badge text-warning fs-5"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                      <h6 class="fw-semibold mb-1"><%= item.hod_name %></h6>
                      <p class="small text-muted mb-2">
                        <%= new Date(item.created_at).toLocaleString() %>
                      </p>
                      <p class="mb-0"><%= item.comment %></p>
                    </div>
                  </div>
                </div>
              <% }); %>
            </div>
          </div>
        </div>
      <% } %>
    </div>
  </div>
</div>

<!-- Feedback Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Provide Feedback for <%= typeof report !== 'undefined' ? report.student_name : 'Student' %></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="feedbackForm" action="/supervisor/feedback" method="POST">
        <div class="modal-body">
          <input type="hidden" name="report_id" value="<%= typeof report !== 'undefined' ? report.id : '' %>">
          <div class="mb-3">
            <label class="form-label fw-semibold">Comments</label>
            <textarea class="form-control" name="comment" rows="6" placeholder="Provide detailed feedback, suggestions, and areas for improvement..." required></textarea>
            <div class="form-text">Be specific and constructive in your feedback to help the student improve.</div>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Action Required</label>
            <select class="form-select" name="action_taken" required>
              <option value="">Select an action...</option>
              <option value="revise">Revise and Resubmit</option>
              <option value="minor_changes">Minor Changes Needed</option>
              <option value="meet_discuss">Schedule Meeting to Discuss</option>
              <option value="no_action">No Action Required</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-send me-1"></i>Submit Feedback
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- File Info Modal -->
<div class="modal fade" id="fileInfoModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-info-circle me-2 text-primary"></i>File Information
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="fileInfoContent">
        <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading file information...</span>
          </div>
          <p class="mt-2 text-muted">Loading file information...</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<style>
.table-borderless td {
  border: none;
  padding: 0.25rem 0;
}

.list-group-item {
  border: none;
  border-bottom: 1px solid #e9ecef;
}

.list-group-item:last-child {
  border-bottom: none;
}

.badge {
  font-weight: 500;
}

.file-info-item {
  padding: 0.5rem 0;
  border-bottom: 1px solid #e9ecef;
}

.file-info-item:last-child {
  border-bottom: none;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Feedback modal
  const feedbackModal = document.getElementById('feedbackModal');
  if (feedbackModal) {
    feedbackModal.addEventListener('show.bs.modal', function(event) {
      // Modal is shown, no need for related target since we're using a button
    });
  }

  // File Info modal handling
  const fileInfoBtn = document.getElementById('fileInfoBtn');
  const fileInfoModal = new bootstrap.Modal(document.getElementById('fileInfoModal'));
  const fileInfoContent = document.getElementById('fileInfoContent');

  if (fileInfoBtn) {
    fileInfoBtn.addEventListener('click', function() {
      const reportId = this.getAttribute('data-report-id');
      loadFileInfo(reportId);
    });
  }

  // Move to next stage button
  const moveNextStageBtn = document.getElementById('moveNextStageBtn');
  if (moveNextStageBtn) {
    moveNextStageBtn.addEventListener('click', function() {
      const reportId = <%= typeof report !== 'undefined' ? report.id : 'null' %>;
      if (reportId && confirm('Are you sure you want to advance this report to the next stage?')) {
        fetch(`/supervisor/reports/${reportId}/move-next-stage`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            location.reload();
          } else {
            alert('Error: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while moving the report to the next stage');
        });
      }
    });
  }

  // Form submission handling
  const feedbackForm = document.getElementById('feedbackForm');
  if (feedbackForm) {
    feedbackForm.addEventListener('submit', function(e) {
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
      submitBtn.disabled = true;
    });
  }
});

// Load file information and display in modal
function loadFileInfo(reportId) {
  const fileInfoContent = document.getElementById('fileInfoContent');
  
  // Show loading state
  fileInfoContent.innerHTML = `
    <div class="text-center py-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading file information...</span>
      </div>
      <p class="mt-2 text-muted">Loading file information...</p>
    </div>
  `;

  // Show modal
  const fileInfoModal = new bootstrap.Modal(document.getElementById('fileInfoModal'));
  fileInfoModal.show();

  // Fetch file information
  fetch(`/supervisor/files/info/${reportId}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const file = data.file;
        fileInfoContent.innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <h6 class="fw-semibold text-muted mb-3">File Details</h6>
              <div class="file-info-item">
                <strong>File Name:</strong>
                <div class="text-muted">${file.fileName}</div>
              </div>
              <div class="file-info-item">
                <strong>File Size:</strong>
                <div class="text-muted">${file.fileSize}</div>
              </div>
              <div class="file-info-item">
                <strong>Report Title:</strong>
                <div class="text-muted">${file.title}</div>
              </div>
              <div class="file-info-item">
                <strong>Report Stage:</strong>
                <div>
                  <span class="badge bg-info">${file.reportStage.replace('_', ' ').toUpperCase()}</span>
                </div>
              </div>
              <div class="file-info-item">
                <strong>Status:</strong>
                <div>
                  ${getStatusBadge(file.status)}
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <h6 class="fw-semibold text-muted mb-3">Additional Information</h6>
              <div class="file-info-item">
                <strong>Student:</strong>
                <div class="text-muted">${file.studentName}</div>
              </div>
              <div class="file-info-item">
                <strong>Supervisor:</strong>
                <div class="text-muted">${file.supervisorName}</div>
              </div>
              <div class="file-info-item">
                <strong>Submitted:</strong>
                <div class="text-muted">${new Date(file.submittedAt).toLocaleString()}</div>
              </div>
              <div class="file-info-item">
                <strong>Feedback Count:</strong>
                <div class="text-muted">${file.feedbackCount}</div>
              </div>
              <div class="file-info-item">
                <strong>Editable:</strong>
                <div>
                  <span class="badge ${file.isEditable ? 'bg-success' : 'bg-secondary'}">
                    ${file.isEditable ? 'Yes' : 'No'}
                  </span>
                </div>
              </div>
              <div class="file-info-item">
                <strong>File Exists:</strong>
                <div>
                  <span class="badge ${file.fileStats.exists ? 'bg-success' : 'bg-danger'}">
                    ${file.fileStats.exists ? 'Yes' : 'No'}
                  </span>
                </div>
              </div>
            </div>
          </div>
          ${!file.fileStats.exists ? `
            <div class="alert alert-warning mt-3">
              <i class="bi bi-exclamation-triangle me-2"></i>
              <strong>Warning:</strong> The physical file was not found on the server.
            </div>
          ` : ''}
        `;
      } else {
        fileInfoContent.innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Error:</strong> ${data.error || 'Failed to load file information'}
          </div>
        `;
      }
    })
    .catch(error => {
      console.error('Error loading file info:', error);
      fileInfoContent.innerHTML = `
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>Error:</strong> Failed to load file information. Please try again.
        </div>
      `;
    });
}

// Helper function to generate status badges
function getStatusBadge(status) {
  const statusMap = {
    'pending': { class: 'bg-warning text-dark', text: 'Pending', icon: 'clock' },
    'approved': { class: 'bg-success', text: 'Approved', icon: 'check-circle' },
    'rejected': { class: 'bg-danger', text: 'Rejected', icon: 'x-circle' },
    'feedback_given': { class: 'bg-info', text: 'Feedback Given', icon: 'chat-text' }
  };
  
  const statusInfo = statusMap[status] || { class: 'bg-secondary', text: status, icon: 'question' };
  
  return `<span class="badge ${statusInfo.class}">
    <i class="bi bi-${statusInfo.icon} me-1"></i>${statusInfo.text}
  </span>`;
}

function approveReport(reportId) {
  if (confirm('Are you sure you want to approve this report?')) {
    fetch(`/supervisor/reports/${reportId}/move-next-stage`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert('Error: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred while approving the report');
    });
  }
}
</script>